<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI åŠ©æ‰‹ - Grassroots Project</title>
  <style>
    :root {
      --primary-color: #1a1a1a;
      --accent-color: #f7931a;
      --bg-color: #ffffff;
      --text-color: #333333;
      --light-gray: #f5f5f5;
      --border-color: #e0e0e0;
      --nav-bg: rgba(255, 255, 255, 0.95);
      --ai-color: #6366f1;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background: var(--light-gray);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      padding: 0.8rem 2rem;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    nav .logo {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--primary-color);
      text-decoration: none;
    }

    nav ul {
      display: flex;
      list-style: none;
      gap: 2rem;
    }

    nav a {
      text-decoration: none;
      color: var(--text-color);
      transition: all 0.3s;
      font-size: 0.95rem;
    }

    nav a:hover, nav a.active {
      color: var(--accent-color);
      font-weight: 500;
    }

    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      cursor: pointer;
      padding: 5px;
    }

    .hamburger span {
      width: 25px;
      height: 2px;
      background: var(--primary-color);
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      width: 100%;
      margin: 0 auto;
      padding: 80px 1rem 1rem;
    }

    /* API Key è®¾ç½® */
    .api-setup {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .api-setup.collapsed {
      padding: 12px 20px;
    }

    .api-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .api-header h3 {
      font-size: 1rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .api-status {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 12px;
    }

    .api-status.connected {
      background: #dcfce7;
      color: #166534;
    }

    .api-status.disconnected {
      background: #fee2e2;
      color: #991b1b;
    }

    .api-body {
      margin-top: 15px;
      display: none;
    }

    .api-setup:not(.collapsed) .api-body {
      display: block;
    }

    .api-guide {
      background: var(--light-gray);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .api-guide ol {
      margin-left: 20px;
    }

    .api-guide a {
      color: var(--ai-color);
    }

    .api-input-group {
      display: flex;
      gap: 10px;
    }

    .api-input-group input {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .api-input-group input:focus {
      outline: none;
      border-color: var(--ai-color);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: var(--ai-color);
      color: white;
    }

    .btn-primary:hover {
      background: #4f46e5;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    /* èŠå¤©åŒºåŸŸ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .chat-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h2 {
      font-size: 1.1rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
    }

    .message.user {
      align-self: flex-end;
      background: var(--ai-color);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.assistant {
      align-self: flex-start;
      background: var(--light-gray);
      color: var(--text-color);
      border-bottom-left-radius: 4px;
    }

    .message.system {
      align-self: center;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.9rem;
      padding: 8px 16px;
    }

    .message.assistant p {
      margin-bottom: 8px;
    }

    .message.assistant p:last-child {
      margin-bottom: 0;
    }

    .message.assistant ul, .message.assistant ol {
      margin-left: 20px;
      margin-bottom: 8px;
    }

    .message.assistant code {
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .message.assistant a {
      color: var(--ai-color);
    }

    .message .task-card {
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
    }

    .message .task-card:hover {
      border-color: var(--ai-color);
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 12px 16px;
      align-self: flex-start;
      background: var(--light-gray);
      border-radius: 12px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    /* è¾“å…¥åŒºåŸŸ */
    .chat-input {
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 10px;
    }

    .chat-input textarea {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      min-height: 48px;
      max-height: 120px;
    }

    .chat-input textarea:focus {
      outline: none;
      border-color: var(--ai-color);
    }

    .chat-input button {
      padding: 12px 24px;
      background: var(--ai-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .chat-input button:hover:not(:disabled) {
      background: #4f46e5;
    }

    .chat-input button:disabled {
      background: #c7c7c7;
      cursor: not-allowed;
    }

    /* å¿«æ·é—®é¢˜ */
    .quick-questions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 10px 20px;
      border-top: 1px solid var(--border-color);
      background: var(--light-gray);
    }

    .quick-btn {
      padding: 6px 12px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .quick-btn:hover {
      border-color: var(--ai-color);
      color: var(--ai-color);
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #666;
      padding: 40px;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .empty-state p {
      max-width: 400px;
      margin-bottom: 20px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: #333;
      color: white;
      border-radius: 8px;
      z-index: 3000;
    }

    .toast.error { background: #d73a4a; }
    .toast.success { background: #28a745; }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      nav { padding: 0.8rem 1rem; }
      nav .logo { font-size: 1.2rem; }
      .hamburger { display: flex; }
      nav ul {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--nav-bg);
        flex-direction: column;
        padding: 1rem;
        gap: 0;
      }
      nav ul.show { display: flex; }
      nav ul li { width: 100%; }
      nav ul li a { padding: 0.8rem 1rem; display: block; }

      .container { padding: 70px 0.5rem 0.5rem; }
      .api-setup { border-radius: 8px; }
      .chat-container { border-radius: 8px; }
      .message { max-width: 90%; }
      .quick-questions { padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <nav>
    <a href="../index.html" class="logo">ğŸŒ± Grassroots Project</a>
    <div class="hamburger" onclick="toggleMenu()">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <ul id="nav-menu">
      <li><a href="../index.html">ğŸ  é¦–é¡µ</a></li>
      <li><a href="about.html">ğŸ’¡ å…³äº</a></li>
      <li><a href="tasks.html">ğŸ“‹ ä»»åŠ¡æ± </a></li>
      <li><a href="kanban.html">ğŸ“Š çœ‹æ¿</a></li>
      <li><a href="people.html">ğŸ‘¥ äººæ± </a></li>
      <li><a href="resources.html">ğŸ“¦ èµ„æºæ± </a></li>
      <li><a href="assistant.html" class="active">ğŸ¤– AI åŠ©æ‰‹</a></li>
      <li><a href="join.html">ğŸš€ åŠ å…¥æˆ‘ä»¬</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- API Key è®¾ç½® -->
    <div id="api-setup" class="api-setup">
      <div class="api-header" onclick="toggleApiSetup()">
        <h3>ğŸ”‘ Kimi Code API è®¾ç½®</h3>
        <span id="api-status" class="api-status disconnected">æœªè¿æ¥</span>
      </div>
      <div class="api-body">
        <div class="api-guide">
          <strong>å¦‚ä½•è·å– API Keyï¼Ÿ</strong>
          <ol>
            <li>è®¿é—® <a href="https://kimi.moonshot.cn/more/member" target="_blank">Kimi ä¼šå‘˜é¡µé¢</a></li>
            <li>è·å– Kimi Code API Key</li>
            <li>å¤åˆ¶ Key ç²˜è´´åˆ°ä¸‹æ–¹</li>
          </ol>
          <p style="margin-top:8px;color:#666;">âš ï¸ Key ä»…å­˜å‚¨åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚</p>
        </div>
        <div class="api-input-group">
          <input type="password" id="api-key-input" placeholder="sk-xxxxxxxxxxxxxxxx" />
          <button class="btn btn-primary" onclick="saveApiKey()">ä¿å­˜</button>
          <button class="btn btn-secondary" onclick="clearApiKey()">æ¸…é™¤</button>
        </div>
      </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-container">
      <div class="chat-header">
        <h2>ğŸ¤– Grassroots AI åŠ©æ‰‹</h2>
        <button class="btn btn-secondary" onclick="clearChat()" style="padding:6px 12px;font-size:0.85rem;">æ¸…ç©ºå¯¹è¯</button>
      </div>

      <div id="chat-messages" class="chat-messages">
        <div class="empty-state" id="empty-state">
          <div class="icon">ğŸ¤–</div>
          <h3>æˆ‘æ˜¯ Grassroots AI åŠ©æ‰‹</h3>
          <p>æˆ‘å¯ä»¥å¸®ä½ äº†è§£é¡¹ç›®ã€æ¨èé€‚åˆä½ çš„ä»»åŠ¡ã€å›ç­”å…³äºåŠ å…¥æµç¨‹çš„é—®é¢˜ã€‚</p>
          <p style="font-size:0.9rem;color:#999;">è¯·å…ˆåœ¨ä¸Šæ–¹è®¾ç½® Kimi API Key</p>
        </div>
      </div>

      <div class="quick-questions">
        <button class="quick-btn" onclick="askQuestion('è¿™ä¸ªé¡¹ç›®æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ')">è¿™ä¸ªé¡¹ç›®æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</button>
        <button class="quick-btn" onclick="askQuestion('æˆ‘ä¼šå†™ä»£ç ï¼Œæœ‰ä»€ä¹ˆä»»åŠ¡é€‚åˆæˆ‘ï¼Ÿ')">é€‚åˆç¨‹åºå‘˜çš„ä»»åŠ¡</button>
        <button class="quick-btn" onclick="askQuestion('æˆ‘æƒ³åŠ å…¥ï¼Œéœ€è¦åšä»€ä¹ˆï¼Ÿ')">å¦‚ä½•åŠ å…¥ï¼Ÿ</button>
        <button class="quick-btn" onclick="askQuestion('ä»€ä¹ˆæ˜¯ä¸‰æ¡è…¿ï¼Ÿ')">ä»€ä¹ˆæ˜¯ä¸‰æ¡è…¿ï¼Ÿ</button>
      </div>

      <div class="chat-input">
        <textarea id="user-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
        <button id="send-btn" onclick="sendMessage()" disabled>å‘é€</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // ==================== é…ç½® ====================
    const API_URL = 'https://api.kimi.com/coding/v1/chat/completions';
    const MODEL = 'kimi-for-coding';
    const STORAGE_KEY = 'grassroots_kimi_api_key';

    // ==================== é¡¹ç›®çŸ¥è¯†åº“ ====================
    const PROJECT_KNOWLEDGE = `
# Grassroots Project çŸ¥è¯†åº“

## é¡¹ç›®ç®€ä»‹
Grassroots Project æ˜¯ä¸€ä¸ªä¸ºè¢«ä½ä¼°çš„ä¸ªä½“æä¾›å¤ºå›å®šä»·æƒçš„åä½œåŸºç¡€çš„é¡¹ç›®ã€‚
- **ä½¿å‘½**ï¼šä¸ºè¢«ä½ä¼°çš„ä¸ªä½“æä¾›å¤ºå›å®šä»·æƒçš„åä½œåŸºç¡€
- **æ„¿æ™¯**ï¼šæ„å»ºä¸€ä¸ªä»·å€¼è¢«å‘ç°çš„ç½‘ç»œï¼Œè®©æ¯ä¸ªå‚ä¸è€…éƒ½èƒ½é€šè¿‡åä½œè·å¾—éçº¿æ€§æˆé•¿
- **æ ¸å¿ƒä¸»å¼ **ï¼šä»·å€¼ä¸æ˜¯è¢«èµ‹äºˆçš„ï¼Œæ˜¯è¢«å‘ç°çš„

## ä¸‰æ¡è…¿
é¡¹ç›®çš„æ ¸å¿ƒæ¶æ„ç”±ä¸‰ä¸ªç›¸ä¹˜ï¼ˆä¸æ˜¯ç›¸åŠ ï¼‰çš„è¦ç´ ç»„æˆï¼š

1. **æ¯”ç‰¹å¸ï¼ˆä¿¡ä»»åŸºç¡€ï¼‰**
   - å»ä¸­å¿ƒåŒ–çš„ä»·å€¼å­˜å‚¨å’Œè½¬ç§»
   - ä¸ä¾èµ–æƒå¨çš„ä¿¡ä»»æœºåˆ¶
   - ä¸å¯ç¯¡æ”¹çš„è´¡çŒ®è®°å½•

2. **è®¡ç®—æœºå’Œç½‘ç»œï¼ˆåä½œæœºåˆ¶ï¼‰**
   - è¿œç¨‹åä½œã€å®æ—¶é€šä¿¡
   - è®©ä»·å€¼å‘ç°å¯ä»¥å‘ç”Ÿ
   - é™ä½åä½œæˆæœ¬

3. **å¤§è¯­è¨€æ¨¡å‹ï¼ˆè®¤çŸ¥å…±è¯†ï¼‰**
   - AI ä½œä¸ºè®¤çŸ¥åè°ƒè€…
   - é™ä½å‚ä¸åšå¼ˆçš„è®¤çŸ¥é—¨æ§›
   - ååŠ©ä»·å€¼åŒ¹é…

æˆé•¿æœºåˆ¶ï¼šä¸‰è€…ç›¸ä¹˜ï¼Œè¿™æ˜¯æŒ‡æ•°çº§æˆé•¿çš„æ ¸å¿ƒæ¥æºã€‚

## æ± å¡˜æ¨¡å¼
æˆ‘ä»¬çš„ç»„ç»‡æ–¹å¼æ˜¯ä¸€ä¸ªå¼€æ”¾çš„æ± å¡˜ï¼š
- **ä»»åŠ¡æ± **ï¼šå¼€æ”¾ä»»åŠ¡ï¼Œä»»ä½•äººå¯ä»¥æ·»åŠ å’Œé¢†å–
- **èµ„æºæ± **ï¼šæ¯”ç‰¹å¸ã€çŸ¥è¯†ã€å·¥å…·ã€äººåŠ›
- **äººæ± **ï¼šæŠ€èƒ½ã€æ—¶é—´ã€å½“å‰å‚ä¸ã€å†å²è´¡çŒ®

åŸåˆ™ï¼šè‡ªç”±ç»„åˆ + AI å¼•å¯¼ï¼Œä»·å€¼åœ¨åšå¼ˆä¸­å‘ç°ã€‚ä¸æ‰¹å‡†ï¼Œåªè®°å½•ã€‚

## ç›®æ ‡ç¾¤ä½“
- åœ°ç†ï¼šå…¨çƒï¼Œé‡ç‚¹ä¸­å›½
- Z ä¸–ä»£ï¼ˆ2000 åï¼‰ã€åº”å±Šæ¯•ä¸šç”Ÿã€80-90 åå†å°±ä¸šäººç¾¤
- å…±åŒç‰¹å¾ï¼šè¢«ä¼ ç»Ÿå°±ä¸šä½“ç³»è¾¹ç¼˜åŒ–æˆ–ä»·å€¼è¢«ä½ä¼°

## å¦‚ä½•åŠ å…¥
1. é˜…è¯»é¡¹ç›®ä»‹ç»ï¼ˆå…³äºé¡µé¢ï¼‰
2. å›ç­”ç­›é€‰é—®å·ï¼ˆåŠ å…¥æˆ‘ä»¬é¡µé¢ï¼‰
3. å‘é€ç­”æ¡ˆåˆ° xiaoping.tang@gmail.com
4. å›å¤åï¼Œæ·»åŠ ä¿¡æ¯åˆ°äººæ± 

## æŠ€èƒ½æ ‡ç­¾è¯´æ˜
| æ ‡ç­¾ | è¯´æ˜ |
|------|------|
| æ–‡æ¡ˆ | å†™ä½œã€å†…å®¹ç­–åˆ’ |
| è§†é¢‘ | è§†é¢‘åˆ¶ä½œã€å‰ªè¾‘ |
| è®¾è®¡ | UI/UXã€å¹³é¢è®¾è®¡ |
| æŠ€æœ¯ | ç¼–ç¨‹ã€å¼€å‘ |
| è¿è¥ | ç¤¾ç¾¤è¿è¥ã€ç”¨æˆ·å¢é•¿ |
| æ²Ÿé€š | æ²Ÿé€šã€åè°ƒ |
| ç¤¾äº¤ | ç¤¾äº¤ã€äººè„‰ |
| æˆ˜ç•¥ | æˆ˜ç•¥è§„åˆ’ã€æ€ç»´ |

## ä»»åŠ¡ä¼˜å…ˆçº§
- P0ï¼šå¿…é¡»å…ˆåšï¼Œç´§æ€¥é‡è¦
- P1ï¼šé‡è¦ä¸ç´§æ€¥
- P2ï¼šæ¢ç´¢æ€§ï¼Œå¯ä»¥å°è¯•

## ç½‘ç«™é“¾æ¥
- é¦–é¡µï¼š/index.html
- å…³äºï¼š/pages/about.html
- ä»»åŠ¡æ± ï¼š/pages/tasks.html
- çœ‹æ¿ï¼š/pages/kanban.html
- äººæ± ï¼š/pages/people.html
- èµ„æºæ± ï¼š/pages/resources.html
- åŠ å…¥æˆ‘ä»¬ï¼š/pages/join.html
`;

    const SYSTEM_PROMPT = `ä½ æ˜¯ Grassroots Project çš„ AI åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯ï¼š
1. å¸®åŠ©ç”¨æˆ·äº†è§£é¡¹ç›®çš„æ„¿æ™¯ã€ä½¿å‘½å’Œè¿ä½œæ–¹å¼
2. æ ¹æ®ç”¨æˆ·çš„æŠ€èƒ½æ¨èé€‚åˆçš„ä»»åŠ¡
3. å¼•å¯¼æ–°äººåŠ å…¥é¡¹ç›®
4. å›ç­”å…³äºé¡¹ç›®çš„å„ç§é—®é¢˜

è¯·åŸºäºä»¥ä¸‹çŸ¥è¯†åº“å›ç­”é—®é¢˜ã€‚å›ç­”è¦ç®€æ´å‹å¥½ï¼Œä½¿ç”¨ä¸­æ–‡ã€‚å¦‚æœæ¶‰åŠå…·ä½“ä»»åŠ¡ï¼Œå¯ä»¥å»ºè®®ç”¨æˆ·å»ä»»åŠ¡æ± é¡µé¢æŸ¥çœ‹ã€‚

${PROJECT_KNOWLEDGE}

å½“å‰å¯ç”¨çš„ä»»åŠ¡ï¼ˆä»ä»»åŠ¡æ± åŠ¨æ€åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åŠ è½½åˆ°åˆ™è¯´ä»»åŠ¡æ± æ­£åœ¨æ›´æ–°ä¸­ï¼Œè¯·ç”¨æˆ·ç›´æ¥è®¿é—®ä»»åŠ¡æ± é¡µé¢ï¼‰ï¼š
{{TASKS}}

å›ç­”é£æ ¼ï¼š
- ç®€æ´æ˜äº†ï¼Œä¸è¦å¤ªé•¿
- å‹å¥½äº²åˆ‡ï¼Œåƒæœ‹å‹ä¸€æ ·èŠå¤©
- å¦‚æœä¸ç¡®å®šï¼Œè¯šå®è¯´æ˜
- é€‚å½“ä½¿ç”¨ emoji å¢åŠ äº²å’ŒåŠ›
- æ¨èä»»åŠ¡æ—¶ï¼Œè¯´æ˜ä»»åŠ¡ç¼–å·ã€åç§°ã€ä¼˜å…ˆçº§å’Œæ‰€éœ€æŠ€èƒ½`;

    // ==================== çŠ¶æ€ ====================
    let messages = [];
    let tasks = [];
    let isLoading = false;

    // ==================== API Key ç®¡ç† ====================
    function getApiKey() {
      return localStorage.getItem(STORAGE_KEY);
    }

    function saveApiKey() {
      const input = document.getElementById('api-key-input');
      const key = input.value.trim();
      if (!key) {
        showToast('è¯·è¾“å…¥ API Key', 'error');
        return;
      }
      localStorage.setItem(STORAGE_KEY, key);
      updateApiStatus();
      toggleApiSetup();
      showToast('API Key å·²ä¿å­˜', 'success');
      document.getElementById('send-btn').disabled = false;
    }

    function clearApiKey() {
      localStorage.removeItem(STORAGE_KEY);
      document.getElementById('api-key-input').value = '';
      updateApiStatus();
      document.getElementById('send-btn').disabled = true;
      showToast('API Key å·²æ¸…é™¤');
    }

    function updateApiStatus() {
      const status = document.getElementById('api-status');
      const key = getApiKey();
      if (key) {
        status.textContent = 'å·²è¿æ¥';
        status.className = 'api-status connected';
        document.getElementById('api-key-input').value = key;
      } else {
        status.textContent = 'æœªè¿æ¥';
        status.className = 'api-status disconnected';
      }
    }

    function toggleApiSetup() {
      const setup = document.getElementById('api-setup');
      setup.classList.toggle('collapsed');
    }

    // ==================== èŠå¤©åŠŸèƒ½ ====================
    async function sendMessage() {
      const input = document.getElementById('user-input');
      const text = input.value.trim();
      if (!text || isLoading) return;

      const apiKey = getApiKey();
      if (!apiKey) {
        showToast('è¯·å…ˆè®¾ç½® API Key', 'error');
        return;
      }

      // æ¸…ç©ºè¾“å…¥
      input.value = '';
      input.style.height = 'auto';

      // éšè—ç©ºçŠ¶æ€
      const emptyState = document.getElementById('empty-state');
      if (emptyState) emptyState.style.display = 'none';

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage('user', text);
      messages.push({ role: 'user', content: text });

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      isLoading = true;
      document.getElementById('send-btn').disabled = true;
      const typingEl = addTypingIndicator();

      try {
        // æ„å»ºç³»ç»Ÿ promptï¼ˆåŒ…å«ä»»åŠ¡åˆ—è¡¨ï¼‰
        const systemPrompt = SYSTEM_PROMPT.replace('{{TASKS}}', formatTasksForPrompt());

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: MODEL,
            messages: [
              { role: 'system', content: systemPrompt },
              ...messages
            ],
            temperature: 0.7,
            max_tokens: 4096
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
        typingEl.remove();

        // æ·»åŠ åŠ©æ‰‹å›å¤
        addMessage('assistant', reply);
        messages.push({ role: 'assistant', content: reply });

      } catch (error) {
        typingEl.remove();
        addMessage('system', 'âš ï¸ ' + error.message);
        console.error('API Error:', error);
      } finally {
        isLoading = false;
        document.getElementById('send-btn').disabled = false;
      }
    }

    function addMessage(role, content) {
      const container = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.className = `message ${role}`;
      
      if (role === 'assistant') {
        div.innerHTML = marked.parse(content);
      } else {
        div.textContent = content;
      }
      
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    function addTypingIndicator() {
      const container = document.getElementById('chat-messages');
      const div = document.createElement('div');
      div.className = 'typing-indicator';
      div.innerHTML = '<span></span><span></span><span></span>';
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
      return div;
    }

    function clearChat() {
      messages = [];
      const container = document.getElementById('chat-messages');
      container.innerHTML = `
        <div class="empty-state" id="empty-state">
          <div class="icon">ğŸ¤–</div>
          <h3>æˆ‘æ˜¯ Grassroots AI åŠ©æ‰‹</h3>
          <p>æˆ‘å¯ä»¥å¸®ä½ äº†è§£é¡¹ç›®ã€æ¨èé€‚åˆä½ çš„ä»»åŠ¡ã€å›ç­”å…³äºåŠ å…¥æµç¨‹çš„é—®é¢˜ã€‚</p>
        </div>
      `;
    }

    function askQuestion(text) {
      document.getElementById('user-input').value = text;
      sendMessage();
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // ==================== ä»»åŠ¡åŠ è½½ ====================
    async function loadTasks() {
      try {
        const response = await fetch(
          'https://api.github.com/repos/grassroots-project/tasks/issues?state=open&per_page=50',
          { headers: { 'Accept': 'application/vnd.github.v3+json' } }
        );
        if (!response.ok) return;
        
        const issues = await response.json();
        tasks = issues.filter(issue => {
          if (issue.pull_request) return false;
          const labels = issue.labels.map(l => l.name);
          if (labels.includes('äººæ± ') || labels.includes('èµ„æºæ± ')) return false;
          return true;
        });
      } catch (error) {
        console.error('Failed to load tasks:', error);
      }
    }

    function formatTasksForPrompt() {
      if (tasks.length === 0) return 'ï¼ˆä»»åŠ¡åˆ—è¡¨åŠ è½½ä¸­...ï¼‰';
      
      return tasks.map(task => {
        const labels = task.labels.map(l => l.name);
        const priority = labels.find(l => ['P0', 'P1', 'P2', 'p0', 'p1', 'p2'].includes(l)) || 'æœªçŸ¥';
        const status = labels.find(l => ['å¾…é¢†', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'].includes(l)) || 'å¾…é¢†';
        const skills = labels.filter(l => !['P0', 'P1', 'P2', 'p0', 'p1', 'p2', 'å¾…é¢†', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'].includes(l));
        
        return `- #${task.number} ${task.title} | ä¼˜å…ˆçº§: ${priority.toUpperCase()} | çŠ¶æ€: ${status} | æŠ€èƒ½: ${skills.join(', ') || 'æ— ç‰¹å®šè¦æ±‚'}`;
      }).join('\n');
    }

    // ==================== UI è¾…åŠ© ====================
    function toggleMenu() {
      document.getElementById('nav-menu').classList.toggle('show');
    }

    function showToast(message, type = '') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    const textarea = document.getElementById('user-input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // ==================== åˆå§‹åŒ– ====================
    updateApiStatus();
    loadTasks();
    
    if (getApiKey()) {
      document.getElementById('api-setup').classList.add('collapsed');
      document.getElementById('send-btn').disabled = false;
    }
  </script>
</body>
</html>
